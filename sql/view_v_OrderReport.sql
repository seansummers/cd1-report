v_OrderReport	CREATE ALGORITHM=UNDEFINED DEFINER=`lextech`@`%` SQL SECURITY DEFINER VIEW `v_OrderReport` AS select `ord`.`id` AS `OrderId`,date_format(cast(`ord`.`created` as date),'%m/%d/%Y') AS `OrderCreationDate`,cast(`ord`.`created` as time) AS `OrderCreationTime`,`ord`.`user_id` AS `CustomerId`,`ord`.`status` AS `OrderStatus`,`user`.`first_name` AS `FirstName`,`user`.`last_name` AS `LastName`,`user`.`email` AS `Email`,`useraddr`.`address` AS `Address`,`useraddr`.`address2` AS `Address 2`,`useraddr`.`city` AS `City`,`useraddr`.`state` AS `State`,`useraddr`.`zip` AS `Zip`,`useraddr`.`postal_code_suffix` AS `PostalCodeSuffix`,`voas`.`Store` AS `Store`,`voas`.`Territory` AS `Region`,if(isnull(`voas`.`CouponCode`),' ',`voas`.`CouponCode`) AS `CouponCodeUsed`,(select `exch`.`via` from `exchanges` `exch` where (`exch`.`order_id` = `ord`.`id`) order by `exch`.`created` desc limit 1) AS `Origin`,(select `voas`.`SubscriptionOrder` from `v_order_address_summary` `voas` where (`voas`.`OrderId` = `ord`.`id`) limit 1) AS `SubscriptionOrder`,(case when (select count(0) from (((`orders` join `user_plan` `up` on((`up`.`customerId` = `orders`.`user_id`))) join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`ct`.`id` in (4,5))) limit 1) then 'Y' else 'N' end) AS `RecurringOrder`,(case when (select count(0) from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`up`.`id` = `ord`.`user_plan_id`) and (`ct`.`id` in (1,4))) limit 1) then 'Weekly' when (select count(0) from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`up`.`id` = `ord`.`user_plan_id`) and (`ct`.`id` in (2,5))) limit 1) then 'Biweekly' else 'One Time' end) AS `Frequency`,(case when (select count(0) from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`up`.`id` = `ord`.`user_plan_id`) and (`ct`.`id` in (1,2))) limit 1) then 'Subscription' when (select count(0) from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`up`.`id` = `ord`.`user_plan_id`) and (`ct`.`id` in (4,5))) limit 1) then 'Recurring' else 'One Time' end) AS `CustomerType`,(select round(coalesce(sum(((`op`.`quantity` * `op`.`amount`) / 100)),0),2) from `order_products` `op` where ((`op`.`product_id` = '5') and isnull(`op`.`deleted_at`) and (`op`.`status` <> 'REMOVED') and (`op`.`order_id` = `ord`.`id`))) AS `NonSubscriptionLaundryTrans`,(select round(coalesce(sum(((`op`.`quantity` * `op`.`amount`) / 100)),0),2) from `order_products` `op` where ((`op`.`product_id` = '5') and isnull(`op`.`deleted_at`) and (`op`.`status` <> 'REMOVED') and (`op`.`order_id` = `ord`.`id`))) AS `LaundryByPoundTrans`,(select coalesce(sum(`op`.`quantity`),0) from `order_products` `op` where ((`op`.`name` in ('Subscription Tote','Non-Subscription Tote')) and isnull(`op`.`deleted_at`) and (`op`.`status` = 'Applied') and (`op`.`order_id` = `ord`.`id`))) AS `WashandFoldTotes`,(select coalesce(sum(`op`.`weight`),0) from `order_products` `op` where ((`op`.`name` = 'Subscription Tote') and isnull(`op`.`deleted_at`) and (`op`.`status` = 'Applied') and (`op`.`order_id` = `ord`.`id`))) AS `WashandFoldPoundsSubscriber`,(select coalesce(sum(`order_products`.`weight`),0) from (`order_products` join `order_cleaning_types` `ct` on((`order_products`.`order_id` = `ct`.`order_id`))) where ((`order_products`.`product_id` = '5') and isnull(`order_products`.`deleted_at`) and (`order_products`.`status` = 'Applied') and (`ct`.`cleaning_type_id` in (1,2)) and (`order_products`.`order_id` = `ord`.`id`))) AS `WashandFoldPoundsOverflow`,(select round(coalesce(sum(((`order_products`.`quantity` * `order_products`.`amount`) / 100)),0),2) from (`order_products` join `order_cleaning_types` `ct` on((`order_products`.`order_id` = `ct`.`order_id`))) where ((`order_products`.`product_id` = '5') and isnull(`order_products`.`deleted_at`) and (`order_products`.`status` = 'Applied') and (`ct`.`cleaning_type_id` in (1,2)) and (`order_products`.`order_id` = `ord`.`id`))) AS `WashandFoldOverflowRevenue`,(select round(coalesce(sum(((`order_products`.`quantity` * `order_products`.`amount`) / 100)),0),2) from (`order_products` join `order_cleaning_types` `ct` on((`order_products`.`order_id` = `ct`.`order_id`))) where ((`order_products`.`product_id` = '5') and isnull(`order_products`.`deleted_at`) and (`order_products`.`status` = 'Applied') and (`order_products`.`order_id` = `ord`.`id`) and (`ct`.`cleaning_type_id` in (3,4,5,6,7)))) AS `WashandFoldRevenueNonSubscription`,(select coalesce(sum(`order_products`.`weight`),0) from (`order_products` join `order_cleaning_types` `ct` on((`order_products`.`order_id` = `ct`.`order_id`))) where ((`order_products`.`product_id` = '5') and isnull(`order_products`.`deleted_at`) and (`order_products`.`status` = 'Applied') and (`order_products`.`order_id` = `ord`.`id`) and (`ct`.`cleaning_type_id` in (3,4,5,6,7)))) AS `WashandFoldPoundsNonSubscription`,(select round(coalesce(sum(`op`.`quantity`),0),2) from ((((`order_products` `op` join `order_cleaning_types` `ct` on((`op`.`order_id` = `ct`.`order_id`))) join `products` `prod` on((`op`.`product_id` = `prod`.`id`))) join `category_subs` `cs` on((`prod`.`subcategory_id` = `cs`.`id`))) join `categories` `c` on((`cs`.`category_id` = `c`.`id`))) where ((`op`.`order_id` = `ord`.`id`) and isnull(`op`.`deleted_at`) and (`op`.`status` = 'APPLIED') and (`c`.`id` = '3') and (`cs`.`id` in ('1','7')))) AS `WashandPressCounts`,(select ((select round(coalesce(sum(((`order_products`.`quantity` * `order_products`.`amount`) / 100)),0),2) from (((`order_products` join `orders` `o` on((`order_products`.`order_id` = `o`.`id`))) join `exchanges` `ex` on((`ex`.`order_id` = `o`.`id`))) join `trips` `tr` on((`tr`.`id` = `ex`.`trip_id`))) where ((`o`.`status` = 'DELIVERED') and isnull(`order_products`.`deleted_at`) and (`order_products`.`order_id` = `ord`.`id`) and (`order_products`.`status` = 'APPLIED') and (`ex`.`type` = 'DELIVERY'))) + (select round(coalesce(sum((`order_price_modifiers`.`amount` / 100)),0),2) from `order_price_modifiers` where ((`order_price_modifiers`.`target_id` = `ord`.`id`) and (`order_price_modifiers`.`status` = 'APPLIED'))))) AS `DeliveredAmount`,(select round(coalesce(sum((`t`.`amount` / 100)),0),2) from (`transactions` `t` join `orders` `o` on((`t`.`order_id` = `o`.`id`))) where ((`o`.`status` = 'DELIVERED') and (`o`.`id` = `ord`.`id`) and (`t`.`type` = 'CHARGE') and isnull(`t`.`parent_id`) and (`t`.`status` = 'COMPLETE'))) AS `ChargedAmount`,(select round(coalesce(sum((`op`.`quantity` * (`op`.`amount` / 100))),0),2) from ((((`order_products` `op` join `order_cleaning_types` `ct` on((`op`.`order_id` = `ct`.`order_id`))) join `products` `prod` on((`op`.`product_id` = `prod`.`id`))) join `category_subs` `cs` on((`prod`.`subcategory_id` = `cs`.`id`))) join `categories` `c` on((`cs`.`category_id` = `c`.`id`))) where ((`op`.`order_id` = `ord`.`id`) and isnull(`op`.`deleted_at`) and (`op`.`status` = 'Applied') and (`c`.`name` = 'Laundry') and (`cs`.`name` = 'Laundry'))) AS `WashandPressTotal`,(select coalesce(sum(`op`.`quantity`),0) from ((((`order_products` `op` join `order_cleaning_types` `ct` on((`op`.`order_id` = `ct`.`order_id`))) join `products` `prod` on((`op`.`product_id` = `prod`.`id`))) join `category_subs` `cs` on((`prod`.`subcategory_id` = `cs`.`id`))) join `categories` `c` on((`cs`.`category_id` = `c`.`id`))) where ((`op`.`order_id` = `ord`.`id`) and isnull(`op`.`deleted_at`) and (`op`.`status` = 'Applied') and (`c`.`name` = 'Dry Clean') and (`cs`.`name` = 'Dry Clean'))) AS `DryCleanCounts`,(select round(coalesce(sum((`op`.`quantity` * (`op`.`amount` / 100))),0),2) from ((((`order_products` `op` join `order_cleaning_types` `ct` on((`op`.`order_id` = `ct`.`order_id`))) join `products` `prod` on((`op`.`product_id` = `prod`.`id`))) join `category_subs` `cs` on((`prod`.`subcategory_id` = `cs`.`id`))) join `categories` `c` on((`cs`.`category_id` = `c`.`id`))) where ((`op`.`order_id` = `ord`.`id`) and isnull(`op`.`deleted_at`) and (`op`.`status` = 'Applied') and (`c`.`name` = 'Dry Clean') and (`cs`.`name` = 'Dry Clean'))) AS `DryCleanTotal`,(select coalesce(sum(`op`.`quantity`),0) from ((((`order_products` `op` join `order_cleaning_types` `ct` on((`op`.`order_id` = `ct`.`order_id`))) join `products` `prod` on((`op`.`product_id` = `prod`.`id`))) join `category_subs` `cs` on((`prod`.`subcategory_id` = `cs`.`id`))) join `categories` `c` on((`cs`.`category_id` = `c`.`id`))) where ((`op`.`order_id` = `ord`.`id`) and isnull(`op`.`deleted_at`) and (`op`.`status` = 'Applied') and (`c`.`name` = 'Laundry') and (`cs`.`name` = 'Household'))) AS `HouseholdCounts`,(select round(coalesce(sum((`op`.`quantity` * (`op`.`amount` / 100))),0),2) from ((((`order_products` `op` join `order_cleaning_types` `ct` on((`op`.`order_id` = `ct`.`order_id`))) join `products` `prod` on((`op`.`product_id` = `prod`.`id`))) join `category_subs` `cs` on((`prod`.`subcategory_id` = `cs`.`id`))) join `categories` `c` on((`cs`.`category_id` = `c`.`id`))) where ((`op`.`order_id` = `ord`.`id`) and isnull(`op`.`deleted_at`) and (`op`.`status` = 'Applied') and (`c`.`name` = 'Laundry') and (`cs`.`name` = 'Household'))) AS `HouseholdTotal`,round(coalesce(`ot`.`CouponApplied`,0),2) AS `CouponApplied`,round(coalesce(`ot`.`DeliveryFee`,0),2) AS `DeliveryFee`,round(coalesce(`ot`.`ItemTotal`,0),2) AS `BaseSales`,greatest(round(((coalesce(`ot`.`ItemTotal`,0) + coalesce(`ot`.`DeliveryFee`,0)) + coalesce(`ot`.`CouponApplied`,0)),2),0) AS `ItemTotal`,round(coalesce(`ot`.`CreditsUsed`,0),2) AS `CreditsUsed`,round(coalesce(greatest(`ot`.`Tax`,0),0),2) AS `Tax`,greatest(round(((((coalesce(`ot`.`CreditsUsed`,0) + coalesce(`ot`.`CouponApplied`,0)) + coalesce(`ot`.`DeliveryFee`,0)) + coalesce(`ot`.`ItemTotal`,0)) + coalesce(`ot`.`Tax`,0)),2),0) AS `GrandTotal`,`userpref`.`starch` AS `Starch`,`userpref`.`pantsCrease` AS `PantsCrease`,`userpref`.`additionalDetails` AS `AdditionalDetails`,`userplan`.`pickupLocation` AS `PickupLocation`,`userplan`.`pickupDetails` AS `PickupDetails`,`ordernotes`.`description` AS `SpecialInstructions`,(select `exch`.`location_type` from `exchanges` `exch` where (`exch`.`order_id` = `ord`.`id`) order by `exch`.`created` desc limit 1) AS `LocationType`,(select date_format(cast(`trips`.`scheduled` as date),'%m/%d/%Y') from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'PICKUP')) order by `exch`.`created` desc limit 1) AS `ScheduledPickupDate`,(select date_format(cast(`trips`.`requested_start` as date),'%m/%d/%Y') from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'PICKUP')) order by `exch`.`created` desc limit 1) AS `RequestedPickupDate`,(select date_format(cast(`trips`.`actual` as date),'%m/%d/%Y') from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'PICKUP')) order by `exch`.`created` desc limit 1) AS `ActualPickupDate`,(select cast(`trips`.`actual` as time) from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'PICKUP')) order by `exch`.`created` desc limit 1) AS `ActualPickupTime`,(select date_format(cast(`trips`.`scheduled` as date),'%m/%d/%Y') from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'DELIVERY')) order by `exch`.`created` desc limit 1) AS `ScheduledDeliveryDate`,(select date_format(cast(`trips`.`requested_start` as date),'%m/%d/%Y') from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'DELIVERY')) order by `exch`.`created` desc limit 1) AS `RequestedDeliveryDate`,(select date_format(cast(`trips`.`actual` as date),'%m/%d/%Y') from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'DELIVERY')) order by `exch`.`created` desc limit 1) AS `ActualDeliveryDate`,(select cast(`trips`.`actual` as time) from (`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'DELIVERY')) order by `exch`.`created` desc limit 1) AS `ActualDeliveryTime`,(select concat(`users2`.`first_name`,' ',`users2`.`last_name`) from ((`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) join `users` `users2` on((`trips`.`dryver_id` = `users2`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'DELIVERY')) order by `exch`.`created` desc limit 1) AS `DeliveryDriver`,(select concat(`users2`.`first_name`,' ',`users2`.`last_name`) from ((`exchanges` `exch` join `trips` on((`exch`.`trip_id` = `trips`.`id`))) join `users` `users2` on((`trips`.`dryver_id` = `users2`.`id`))) where ((`exch`.`order_id` = `ord`.`id`) and (`exch`.`type` = 'PICKUP')) order by `exch`.`created` desc limit 1) AS `PickupDriver`,(case when (`ord`.`status` in ('PICKUP CANCELED','PICKUP NO SHOW')) then 'Y' else 'N' end) AS `PickupSkipped`,(select coalesce(`exch`.`status`,NULL) from `exchanges` `exch` where ((`exch`.`order_id` = `ord`.`id`) and (`ord`.`status` in ('PICKUP CANCELED','PICKUP NO SHOW')) and (`exch`.`type` = 'PICKUP')) order by `exch`.`created` desc limit 1) AS `SkippedBy`,`ratings`.`score` AS `NumberOfStars`,`ratings`.`notes` AS `Review` from ((((((((((`orders` `ord` join `users` `user` on((`ord`.`user_id` = `user`.`id`))) left join `user_addresses` `useraddr` on(((`ord`.`user_id` = `useraddr`.`user_id`) and (`useraddr`.`status` = 'ACTIVE')))) left join `v_order_address_summary` `voas` on((`ord`.`id` = `voas`.`OrderId`))) left join `v_OrderTotals` `ot` on((`ot`.`OrderId` = `ord`.`id`))) left join `user_preference` `userpref` on((`ord`.`user_id` = `userpref`.`customerId`))) left join `user_plan` `userplan` on(((`ord`.`user_id` = `userplan`.`customerId`) and (`userplan`.`enabled` = 1)))) left join `order_notes` `ordernotes` on(((`ord`.`id` = `ordernotes`.`order_id`) and (`ordernotes`.`type` = 'customer')))) left join `order_requested_cleaning_types` `orct` on((`ord`.`id` = `orct`.`order_id`))) left join `cleaning_types` `ct` on((`orct`.`cleaning_type_id` = `ct`.`id`))) left join `ratings` on((`ord`.`id` = `ratings`.`order_id`))) where (`ord`.`status` <> 'DUPLICATE') group by `ord`.`id` order by `OrderId`	utf8mb4	utf8mb4_general_ci
