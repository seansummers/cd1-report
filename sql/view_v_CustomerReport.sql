v_CustomerReport	CREATE ALGORITHM=UNDEFINED DEFINER=`lextech`@`%` SQL SECURITY DEFINER VIEW `v_CustomerReport` AS select `user`.`id` AS `CustomerId`,(case when ((select count(0) from `orders` where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` in ('PICKUP NO SHOW','PICKUP CANCELED')))) <> 0) then 'N' when (((select count(0) from `orders` where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` in ('PICKUP SCHEDULED','PICKUP EN ROUTE','PICKUP ARRIVING','PROCESSING','INVALID CREDIT CARD','CLEANING','READY TO BILL','READY','DELIVERY SCHEDULED','DELIVERY EN ROUTE','DELIVERY ARRIVING','DELIVERY NO SHOW','DELIVERY CANCELED')))) <> 0) and ((select count(0) from `orders` where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` = 'DELIVERED'))) = 0)) then 'Y' else 'N' end) AS `NewCustomer`,`user`.`first_name` AS `FirstName`,`user`.`last_name` AS `LastName`,`user`.`email` AS `EmailAddress`,`user`.`phone` AS `PhoneNumber`,`user`.`referral_code` AS `UserReferralCode`,`addr`.`address` AS `Address`,`addr`.`address2` AS `Address2`,`addr`.`city` AS `City`,`addr`.`state` AS `State`,`addr`.`zip` AS `ZipCode`,`addr`.`postal_code_suffix` AS `ZipPlus4Code`,`voas`.`Store` AS `Store`,`voas`.`Territory` AS `Territory`,(case when (select count(0) from ((`cleaning_types` `ct` join `plans` `p` on((`p`.`programId` = `ct`.`id`))) join `user_plan` `up` on((`up`.`planId` = `p`.`id`))) where ((`up`.`enabled` = 1) and (`up`.`customerId` = `user`.`id`) and (`ct`.`id` in (1,2)))) then 'Subscription' when (select count(0) from ((`cleaning_types` `ct` join `plans` `p` on((`p`.`programId` = `ct`.`id`))) join `user_plan` `up` on((`up`.`planId` = `p`.`id`))) where ((`up`.`enabled` = 1) and (`up`.`customerId` = `user`.`id`) and (`ct`.`id` in (4,5)))) then 'Reccuring' else 'One time' end) AS `CurrentCustomerType`,(select `ct`.`frequency` from ((`cleaning_types` `ct` join `plans` `p` on((`p`.`programId` = `ct`.`id`))) join `user_plan` `up` on((`up`.`planId` = `p`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`up`.`enabled` = 1) and (`ct`.`id` in (1,2,4,5))) limit 1) AS `Frequency`,(case when ((select count(0) from `user_plan` `up` where (`up`.`customerId` = `user`.`id`)) = 1) then (select date_format(cast(`up`.`effectiveDate` as date),'%m/%d/%Y') from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`enabled` = 1) and (`up`.`effectiveDate` <= curdate()) and (`ct`.`id` not in (3,4,5,6)) and (`up`.`customerId` = `user`.`id`)) order by `up`.`effectiveDate` desc limit 1) else (case when ((select `ct`.`id` from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`enabled` = 1) and (`up`.`effectiveDate` <= curdate()) and (`up`.`customerId` = `user`.`id`)) order by `up`.`effectiveDate` desc limit 1) in (3,4,5,6)) then (select date_format(cast(`up2`.`effectiveDate` as date),'%m/%d/%Y') from (((((`user_plan` `up1` join `user_plan` `up2` on((`up1`.`customerId` = `up2`.`customerId`))) join `plans` `p` on((`up1`.`planId` = `p`.`id`))) join `plans` `p2` on((`up2`.`planId` = `p2`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) join `cleaning_types` `ct2` on((`p2`.`programId` = `ct2`.`id`))) where ((`ct`.`id` in (3,4,5,6)) and (`up1`.`effectiveDate` <= curdate()) and (`ct2`.`id` not in (3,4,5,6)) and (`up1`.`customerId` = `user`.`id`)) order by `up1`.`customerId`,`up1`.`effectiveDate`,`up2`.`signupDate` desc limit 1) else (select date_format(cast(`up`.`effectiveDate` as date),'%m/%d/%Y') from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`enabled` = 1) and (`ct`.`id` not in (3,4,5,6)) and (`up`.`customerId` = `user`.`id`)) order by `up`.`effectiveDate` desc limit 1) end) end) AS `SubscriptionOptInDate`,(case when (`addr`.`out_of_territory_range` = 1) then 'N' else 'Y' end) AS `InTerritory`,(select (case when ((select `ct`.`id` from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`enabled` = 1) and (`up`.`customerId` = `user`.`id`)) order by `up`.`effectiveDate` desc limit 1) in (1,2)) then NULL else (case when ((select `ct`.`id` from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`effectiveDate` <= curdate()) and (`up`.`customerId` = `user`.`id`)) order by `up`.`effectiveDate` desc limit 1,1) in (3,4,5,6)) then (select date_format(cast(`up1`.`effectiveDate` as date),'%m/%d/%Y') from (((((`user_plan` `up1` join `user_plan` `up2` on((`up1`.`customerId` = `up2`.`customerId`))) join `plans` `p` on((`up1`.`planId` = `p`.`id`))) join `plans` `p2` on((`up2`.`planId` = `p2`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) join `cleaning_types` `ct2` on((`p2`.`programId` = `ct2`.`id`))) where ((`ct`.`id` in (3,4,5,6)) and (`up1`.`effectiveDate` <= curdate()) and (`up1`.`effectiveDate` >= `up2`.`effectiveDate`) and (`ct2`.`id` not in (3,4,5,6)) and (`up1`.`customerId` = `user`.`id`)) order by `up1`.`customerId`,`up1`.`effectiveDate`,`up2`.`signupDate` desc limit 1) else (case when ((select `ct`.`id` from ((`user_plan` `up` join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`effectiveDate` <= curdate()) and (`up`.`enabled` = 1) and (`up`.`customerId` = `user`.`id`)) order by `up`.`effectiveDate` desc,`up`.`id` desc limit 1) in (3,4,5,6)) then (select date_format(cast(`up1`.`effectiveDate` as date),'%m/%d/%Y') from (((((`user_plan` `up1` join `user_plan` `up2` on((`up1`.`customerId` = `up2`.`customerId`))) join `plans` `p` on((`up1`.`planId` = `p`.`id`))) join `plans` `p2` on((`up2`.`planId` = `p2`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) join `cleaning_types` `ct2` on((`p2`.`programId` = `ct2`.`id`))) where ((`ct`.`id` not in (1,2)) and (`up1`.`effectiveDate` <= curdate()) and (`ct2`.`id` in (1,2)) and (`up1`.`customerId` = `user`.`id`)) order by `up1`.`customerId`,`up1`.`created` desc,`up1`.`effectiveDate`,`up2`.`signupDate` desc limit 1) else (select date_format(cast(`up1`.`effectiveDate` as date),'%m/%d/%Y') from (((((`user_plan` `up1` join `user_plan` `up2` on((`up1`.`customerId` = `up2`.`customerId`))) join `plans` `p` on((`up1`.`planId` = `p`.`id`))) join `plans` `p2` on((`up2`.`planId` = `p2`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) join `cleaning_types` `ct2` on((`p2`.`programId` = `ct2`.`id`))) where ((`ct`.`id` in (3,4,5,6)) and (`up1`.`effectiveDate` <= curdate()) and (`up1`.`effectiveDate` > `up2`.`effectiveDate`) and (`ct2`.`id` not in (3,4,5,6)) and (`up1`.`customerId` = `user`.`id`)) order by `up1`.`customerId`,`up1`.`created` desc,`up1`.`effectiveDate`,`up2`.`signupDate` desc limit 1) end) end) end)) AS `SubscriptionOptOutDate`,(select `voas`.`CouponCode` order by `voas`.`OrderId` limit 1) AS `FirstOrderCouponCode`,(case when (select count(0) from (((`orders` join `user_plan` `up` on((`up`.`customerId` = `orders`.`user_id`))) join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`ct`.`id` in (1,2))) limit 1) then 'Subscription' when (select count(0) from ((((`orders` join `user_plan` `up` on((`up`.`customerId` = `orders`.`user_id`))) join `plans` `p` on((`up`.`planId` = `p`.`id`))) join `orders` `o2` on((`o2`.`user_id` = `up`.`customerId`))) join `cleaning_types` `ct` on((`p`.`programId` = `ct`.`id`))) where ((`up`.`customerId` = `user`.`id`) and (`ct`.`id` in (4,5)) and (`o2`.`created` > `orders`.`created`)) limit 1) then 'Reccuring' else 'One time' end) AS `FirstOrderType`,(select count(0) from DUAL  where (`voas`.`CouponCode` is not null)) AS `TotalOfPromoCodes`,date_format(cast(`user`.`created` as date),'%m/%d/%Y') AS `RegistrationDate`,cast(`user`.`created` as time) AS `RegistrationTime`,(select date_format(cast(`trips`.`actual` as date),'%m/%d/%Y') from ((`orders` join `exchanges` `exch` on((`orders`.`id` = `exch`.`order_id`))) join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` = 'Delivered') and (`exch`.`type` = 'DELIVERY')) order by `orders`.`created` limit 1) AS `FirstOrderDate`,(select cast(`trips`.`actual` as time) from ((`orders` join `exchanges` `exch` on((`orders`.`id` = `exch`.`order_id`))) join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` = 'Delivered') and (`exch`.`type` = 'DELIVERY')) order by `orders`.`created` limit 1) AS `FirstOrderTime`,(select date_format(cast(`trips`.`actual` as date),'%m/%d/%Y') from ((`orders` join `exchanges` `exch` on((`orders`.`id` = `exch`.`order_id`))) join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` = 'Delivered') and (`exch`.`type` = 'DELIVERY')) order by `orders`.`created` desc limit 1) AS `LastOrderDate`,(select cast(`trips`.`actual` as time) from ((`orders` join `exchanges` `exch` on((`orders`.`id` = `exch`.`order_id`))) join `trips` on((`exch`.`trip_id` = `trips`.`id`))) where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` = 'Delivered') and (`exch`.`type` = 'DELIVERY')) order by `orders`.`created` desc limit 1) AS `LastOrderTime`,(select date_format(cast(`orders`.`created` as date),'%m/%d/%Y') from `orders` where (`orders`.`user_id` = `user`.`id`) order by `orders`.`created` limit 1) AS `FirstOrderSubmittedDate`,(select count(0) from `orders` where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` = 'DELIVERED'))) AS `TotalNumberOfOrders`,(select date_format(cast(`orders`.`requested_ready_date` as date),'%m/%d/%Y') from `orders` where ((`orders`.`user_id` = `user`.`id`) and (`orders`.`status` = 'PICKUP SCHEDULED')) order by `orders`.`requested_ready_date` desc limit 1) AS `requested_ready_date`,(select cast(`orders`.`created` as time) from `orders` where (`orders`.`user_id` = `user`.`id`) order by `orders`.`created` limit 1) AS `FirstOrderSubmittedTime`,(case when isnull(`voas`.`SubscriptionOrder`) then 'N' else convert(`voas`.`SubscriptionOrder` using utf8mb4) end) AS `SubscriptionOrder`,(case when isnull(`voas`.`DeliveryFrequency`) then 'None' else `voas`.`DeliveryFrequency` end) AS `RecurringOrder`,if((`voas`.`dryCleaningTotals` > 0),'Y','N') AS `UsedDryCleaning`,(select ifnull(sum(`voas1`.`NumberOfBags`),0) from `v_order_address_summary` `voas1` where ((`voas1`.`user_id` = `user`.`id`) and (`voas1`.`OrderStatus` = 'DELIVERED'))) AS `TotalNumberOfBags`,`up`.`planTotes` AS `SubscribedBags`,(select count(0) from `orders` `o` where ((`o`.`user_id` = `user`.`id`) and (`o`.`status` in ('PICKUP NO SHOW','PICKUP CANCELED')))) AS `TotalSkippedOrders`,(select sum(greatest(round(((coalesce(`ot`.`ItemTotal`,0) + coalesce(`ot`.`DeliveryFee`,0)) + coalesce(`ot`.`CouponApplied`,0)),2),0)) from (`v_OrderTotals` `ot` join `orders` `o` on((`o`.`id` = `ot`.`OrderId`))) where ((`o`.`user_id` = `user`.`id`) and (`o`.`status` = 'DELIVERED'))) AS `TotalOrderSpend`,coalesce((`uc`.`credits` - `uc`.`used_credits`),0) AS `CreditsRemaining`,`voas`.`CompletedCustomerOrders` AS `CustomerOrders`,(select count(0) from `users` `u2` where ((`u2`.`referrer_type` like '%Users%') and (`u2`.`referrer_id` = `user`.`id`))) AS `Referred`,(select round(sum((`st`.`amount` / 100)),2) from `subscription_transactions` `st` where ((`st`.`user_id` = `user`.`id`) and (`st`.`status` = 'COMPLETE') and ((`st`.`type` = 'CHARGE') or (`st`.`type` = 'REFUND-CLEANER')))) AS `TotalSubscriptionSpend`,(select round(ifnull(sum(`t`.`TransactionAmount`),0),2) from `v_CustomerOrderTransactionReport` `t` where ((`t`.`CustomerId` = `user`.`id`) and (`t`.`TransactionType` in ('REFUND-CLEANER','REFUND-NONE')) and (`t`.`TransactionStatus` = 'COMPLETE'))) AS `TotalRefunds` from ((((`users` `user` join `user_plan` `up` on(((`user`.`id` = `up`.`customerId`) and (`up`.`enabled` = 1)))) left join `user_credits` `uc` on((`user`.`id` = `uc`.`user_id`))) left join `v_order_address_summary` `voas` on((`user`.`id` = `voas`.`user_id`))) left join `user_addresses` `addr` on(((`user`.`id` = `addr`.`user_id`) and (`addr`.`status` = 'Active')))) group by `user`.`id`	utf8mb4	utf8mb4_general_ci
